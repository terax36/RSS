name: CI

on:
  workflow_dispatch:
  push:
    branches:
      - "main"
      - "ci/**"
  pull_request:

jobs:
  build-and-test:
    runs-on: macos-14
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - name: Select Xcode 15.4
        run: sudo xcode-select -switch /Applications/Xcode_15.4.app
      - name: Resolve dependencies
        run: swift package resolve
      - name: Build and test (iOS 17.5)
        run: |
          set -o pipefail
          xcodebuild build-for-testing \
            -project KitsuneReader.xcodeproj \
            -scheme KitsuneReader \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.5' \
            -skipPackagePluginValidation \
            -allowProvisioningUpdates | tee build.log
      - name: Publish failure snippet
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          tail -n 200 build.log > tail.log || true
          python - <<'PY'
import json, os, urllib.request
token = os.environ["GITHUB_TOKEN"]
owner, repo = os.environ["GITHUB_REPOSITORY"].split("/")
sha = os.environ["COMMIT_SHA"]
with open("tail.log", "r", encoding="utf-8", errors="ignore") as fh:
    body = fh.read()
payload = json.dumps({"body": f"``````\n{body}\n``````"}).encode()
req = urllib.request.Request(
    f"https://api.github.com/repos/{owner}/{repo}/commits/{sha}/comments",
    data=payload,
    headers={
        "Authorization": f"token {token}",
        "Accept": "application/vnd.github+json",
    },
    method="POST",
)
with urllib.request.urlopen(req) as resp:
    print("Posted failure snippet", resp.status)
PY
